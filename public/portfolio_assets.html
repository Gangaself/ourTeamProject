<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Assets</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary-color: #4361ee;
      --danger-color: #e63946;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f8f9fa;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .header h2 {
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header .btn {
      background: var(--primary-color);
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      font-size: 0.95rem;
    }

    .asset-list {
      list-style: none;
      padding: 0;
    }

    .asset-list li {
      background: white;
      padding: 16px;
      margin-bottom: 12px;
      border-left: 4px solid var(--primary-color);
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .positive {
      color: #4CAF50;
    }

    .negative {
      color: #F44336;
    }

    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .chart-box {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .chart-box h3 {
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    canvas {
      width: 100% !important;
      height: 300px !important;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <div class="container">
    <div class="header">
      <h2><i class="fas fa-wallet"></i> Portfolio Assets</h2>
      <a href="javascript:history.back()" class="btn"><i class="fas fa-arrow-left"></i> Back</a>
    </div>

    <ul class="asset-list" id="asset-list"></ul>

    <div class="charts">
      <div class="chart-box">
        <h3><i class="fas fa-chart-pie"></i> Asset Allocation</h3>
        <canvas id="asset-pie-chart"></canvas>
      </div>

      <div class="chart-box">
        <h3><i class="fas fa-chart-bar"></i> Asset Value Comparison</h3>
        <canvas id="asset-comparison-chart"></canvas>
      </div>

      <div class="chart-box">
        <h3><i class="fas fa-layer-group"></i> Asset Type Breakdown</h3>
        <canvas id="asset-type-chart"></canvas>
      </div>
    </div>
  </div>

  <script>
    async function loadAssets() {
      const urlParams = new URLSearchParams(window.location.search);
      const portfolioId = urlParams.get('portfolio_id');
      if (!portfolioId) {
        document.getElementById('asset-list').innerHTML = '<li>portfolio_id parameter is missing.</li>';
        return;
      }

      try {
        const res = await fetch(`/api/assets?portfolio_id=${portfolioId}`);
        const assets = await res.json();
        renderAssetList(assets);
        renderAllCharts(assets);
      } catch (e) {
        console.error(e);
        document.getElementById('asset-list').innerHTML = '<li>Failed to load data. Please try again.</li>';
      }
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const year = date.getFullYear();
      return `${month}/${day}/${year}`;
    }

    function renderAssetList(assets) {
      const list = document.getElementById('asset-list');
      if (!assets || assets.length === 0) {
        list.innerHTML = '<li>No asset records.</li>';
        return;
      }

      list.innerHTML = '';
      assets.forEach(asset => {
        const currentValue = (asset.current_price || asset.purchase_price) * asset.quantity;
        const purchaseValue = asset.purchase_price * asset.quantity;
        const profit = currentValue - purchaseValue;
        const profitClass = profit >= 0 ? 'positive' : 'negative';
        const profitText = profit >= 0 ? `+¥${Math.abs(profit).toLocaleString()}` : `-¥${Math.abs(profit).toLocaleString()}`;
        const ratio = (Math.abs(profit) / purchaseValue * 100).toFixed(2);

        const li = document.createElement('li');
        li.innerHTML = `
          <b>${asset.name}</b> (${asset.symbol}) - ${asset.type}<br>
          Current Value: ¥${currentValue.toLocaleString()} | Cost: ¥${purchaseValue.toLocaleString()}<br>
          P/L: <span class="${profitClass}">${profitText} (${ratio}%)</span><br>
          Quantity: ${asset.quantity} | Purchase Date: ${formatDate(asset.purchase_date)}
        `;
        list.appendChild(li);
      });
    }

    function renderAllCharts(assets) {
      if (!assets || assets.length === 0) return;
      drawPieChart(assets);
      drawComparisonChart(assets);
      drawTypeChart(assets);
    }

    function drawPieChart(assets) {
      const ctx = document.getElementById('asset-pie-chart').getContext('2d');
      const data = assets.map(a => ({ name: a.name, value: (a.current_price || a.purchase_price) * a.quantity }));

      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.map(d => d.name),
          datasets: [{
            data: data.map(d => d.value),
            backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff']
          }]
        },
        options: {
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => {
                  const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                  const pct = Math.round((ctx.raw / total) * 100);
                  return `${ctx.label}: ¥${ctx.raw.toLocaleString()} (${pct}%)`;
                }
              }
            }
          }
        }
      });
    }

    function drawComparisonChart(assets) {
      const ctx = document.getElementById('asset-comparison-chart').getContext('2d');
      const labels = assets.map(a => `${a.name} (${a.symbol})`);
      const purchase = assets.map(a => a.purchase_price * a.quantity);
      const current = assets.map(a => (a.current_price || a.purchase_price) * a.quantity);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Cost', data: purchase, backgroundColor: '#ff6384' },
            { label: 'Current Value', data: current, backgroundColor: '#36a2eb' }
          ]
        },
        options: {
          scales: {
            y: {
              ticks: {
                callback: val => '¥' + val.toLocaleString()
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => {
                  const value = ctx.raw;
                  if (ctx.datasetIndex === 1) {
                    const diff = value - purchase[ctx.dataIndex];
                    const pct = (diff / purchase[ctx.dataIndex] * 100).toFixed(2);
                    return [`${ctx.dataset.label}: ¥${value.toLocaleString()}`, `P/L: ¥${diff.toLocaleString()} (${pct}%)`];
                  }
                  return `${ctx.dataset.label}: ¥${value.toLocaleString()}`;
                }
              }
            }
          }
        }
      });
    }

    function drawTypeChart(assets) {
      const ctx = document.getElementById('asset-type-chart').getContext('2d');
      const typeTotals = {};
      assets.forEach(a => {
        const type = a.type || 'Other';
        const val = (a.current_price || a.purchase_price) * a.quantity;
        typeTotals[type] = (typeTotals[type] || 0) + val;
      });

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(typeTotals),
          datasets: [{
            label: 'Asset Value',
            data: Object.values(typeTotals),
            backgroundColor: '#36a2eb'
          }]
        },
        options: {
          scales: {
            y: {
              ticks: {
                callback: val => '¥' + val.toLocaleString()
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => '¥' + ctx.raw.toLocaleString()
              }
            }
          }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', loadAssets);
  </script>
</body>

</html>